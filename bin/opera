#!/bin/sh


_operas() {
    ls -1 /usr/bin/opera{,-{stable,beta,developer,next}} 2>/dev/null |
    xargs -r -n1 realpath
}

_opera_versions() {
    _operas |
    while read OPERA ; do
        if [ -x "${OPERA}" ] ; then
            printf "%s\t%s\n" "$("${OPERA}" --version 2>/dev/null)" "${OPERA}"
        fi
    done
}

_best_opera() {
    _opera_versions |
    sort -g |
    tail -n1 |
    cut -f2
}

_paxctl() {
    PAXCTL="$(PATH="${PATH}:/bin:/sbin:/usr/bin:/usr/sbin" which paxctl)"

    echo "${PAXCTL}"
}

_pax_flags() {
    if [ -x "$(_paxctl)" ] ; then
        "$(_paxctl)" -v "$1" |
        awk -v 'FS= *: *' '/_PAX *:/ { print $2 }' |
        grep -iv 'not found'
    fi
}

OPERA="$(_best_opera)"

if ! _pax_flags "${OPERA}" | grep -q 'm' ; then
    echo "Please disable PaX MPROTECT for ${OPERA}" 1>&2
    echo "sudo $(_paxctl) -m ${OPERA}" 1>&2
fi

exec "${OPERA}" "${@}"
