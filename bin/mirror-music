#!/bin/sh

MUSIC_DIR="$HOME/Dokumente/musik"
REMOTE_HOST="narsbo"
REMOTE_DIR="musik"
REMOTE_USER="daniel"
SMB_URL="smb://WORKGROUP;${REMOTE_USER}@${REMOTE_HOST}/${REMOTE_DIR}"
GVFS_DIR="/run/user/${UID}/gvfs"
RSYNC_OPTS="-hir --delete --delete-after --modify-window=5 --stats"

renice 20 $$ 1>/dev/null
ionice -c 3 -p$$
chmod -R a-w "${MUSIC_DIR}"

if [ -d "${MUSIC_DIR}" ] ; then
    gvfs-mount -i "${SMB_URL}"

    DIR="$(find "${GVFS_DIR}"/ -maxdepth 1 \
                               -type d \
                               -iname "*${REMOTE_HOST}*${REMOTE_DIR}*" \
                               -printf "%p\n" |
           head -n1)"

    if [ -d "${DIR}" ] ; then
        echo "${MUSIC_DIR}/ -> ${DIR}/"
        rsync -t ${RSYNC_OPTS} "${MUSIC_DIR}"/ "${DIR}"/
    else
        "gvfs mount point for ${SMB_URL} not found in ${GVFS_DIR}"
    fi

    gvfs-mount -u "${SMB_URL}"
fi
