#!/bin/sh

MUSIC_DIR="$HOME/Dokumente/musik"
REMOTE_HOST="narsbo"
REMOTE_DIR="musik"
REMOTE_USER="admin"
REMOTE_DOMAIN="WORKGROUP"
SMB_URL="smb://${REMOTE_DOMAIN};${REMOTE_USER}@${REMOTE_HOST}/${REMOTE_DIR}"
GVFS_DIR="/run/user/${UID}/gvfs"

renice 20 $$ 1>/dev/null
ionice -c 3 -p$$

if [ -d "${MUSIC_DIR}" ] ; then
    gvfs-mount "${SMB_URL}"

    DIR="${GVFS_DIR}/$(ls "${GVFS_DIR}" 2>/dev/null |
                     grep -i "domain=${REMOTE_DOMAIN}" |
                     grep -i "server=${REMOTE_HOST}" |
                     grep -i "share=${REMOTE_SHARE}" |
                     grep -i "user=${REMOTE_USER}")"

    if [ -d "${DIR}" ] ; then
        sleep 0.5
        echo "${DIR}"
        rsync -hrt --modify-window=70 --verbose --stats --delete-after "${MUSIC_DIR}"/ "${DIR}"/
    fi

    gvfs-mount -u "${SMB_URL}"
fi
