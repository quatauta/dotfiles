#!/bin/sh

windows() {
    (
        wmctrl -lp |
        while read wid desktop pid host name ; do
            printf -- '%s\n' "${name}"
        done
        swaymsg -t get_tree |
        jq -r '.nodes[1].nodes[].nodes[] | .. | .name?' |
        grep -v '^null$'
    ) |
    sort -u
}

question() {
    local question text windows

    question="$@"
    windows="$(windows)"

    if [ -z "${windows}" ] ; then
        return 0
    fi

    text="${text}Es sind noch Programme gestartet:\n\n"
    text="${text}${windows}\n\n"
    text="${text}${question}"

    zenity --question \
        --title="${question}" \
        --ok-label="_Ja" \
        --cancel-label="_Nein" \
        --text="${text}" \
        --width=300
}

if question "Session beenden?" ; then
    gnome-session-quit --logout --force --no-prompt
    swaymsg exit
    pkill -TERM /usr/bin/fluxbox
fi
