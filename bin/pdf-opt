#!/bin/bash

INPUT="${1}"
METADATA="${INPUT}.meta"
SHRINKED="${INPUT/.pdf/-opt.pdf}"
LINEAR="${INPUT/.pdf/-opt-linear.pdf}"

if [ -z "${INPUT}" ] ; then
    echo "usage: $0 [input.pdf]"
    echo
    echo "Optimize/shrink a pdf file with ghostscript."
    exit 1
fi

[ -e "${METADATA}" ] && echo "Metadata file ${METADATA} exists. Please delete."           && exit 2
[ -e "${SHRINKED}" ] && echo "Shrinked pdf file ${SHRINKED} exists. Please delete."       && exit 2
[ -e "${LINEAR}" ]   && echo "Optimized/linear pdf file ${LINEAR} exists. Please delete." && exit 2

pdfinfo "${INPUT}" |
head -6 |
while IFS=":" read field value ; do
    oct="$(echo -n $value | echo $(recode ..UTF-16/o) | sed -e 's|0\([0-7]\{3\}\)\(, \)\?|\\\1|g')"
    printf '%s:   %s\n' "${field}" "${oct}"
done |
perl -p -e "s/^/  \//g; s/: \s+(.*)/ (\1)/g; s/ \)/\)/g; s/  \/Title/[ \/Title/" >"${METADATA}"
echo "  /DOCINFO pdfmark" >>"${METADATA}"
echo "[ {Catalog} << /ViewerPreferences << /DisplayDocTitle true >> >> /PUT pdfmark" >>"${METADATA}"

gs -dSAFER -dNOPAUSE -dBATCH -dEmbedAllFonts \
    -sDEVICE=pdfwrite \
    -dPDFSETTINGS=/prepress \
    -sOutputFile="${SHRINKED}" \
    "${INPUT}" \
    -c .setpdfwrite \
    -f "${METADATA}"
pdfopt "${SHRINKED}" "${LINEAR}"

rm -f "${METADATA}"
