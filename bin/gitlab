#!/bin/sh

export IMAGE="gitlab/gitlab-ce:latest"
export CONTAINER="gitlab"
export HOSTNAME="$(hostname -f)"
export HTTP="5080"
export HTTPS="5443"
export SSHD="5022"
export REGISTRY="5005"
export PORTS="${HTTPS}:${HTTPS} ${HTTP}:${HTTP} ${SSHD}:22 ${REGISTRY}:${REGISTRY}"
export VOLUMES="/var/lib/gitlab/config:/etc/gitlab
                /var/lib/gitlab/logs:/var/log/gitlab
                /var/lib/gitlab/data:/var/opt/gitlab"
export GITLAB_OMNIBUS_CONFIG="external_url 'https://${HOSTNAME}:${HTTPS}/';
                              nginx['redirect_http_to_https'] = true;
                              gitlab_rails['gitlab_shell_ssh_port'] = ${SSHD};
                              registry_external_url 'https://${HOSTNAME}:${REGISTRY}/';"

export DOCKER="sudo docker"
groups | egrep -q -i '\Wdocker\W' && export DOCKER="docker"

_exists() {
    "${DOCKER}" ps -a -f name="${CONTAINER}" | grep -q "${CONTAINER}"
}

_started() {
    "${DOCKER}" ps -f name="${CONTAINER}" | grep -q "${CONTAINER}"
}

_gc() {
    if _started ; then
        echo "Garbage collection for gitlab docker image registry..."
        "${DOCKER}" exec "${CONTAINER}" gitlab-ctl registry-garbage-collect
    fi
}

_create() {
    _stop
    _remove
    echo "Creating docker container ${CONTAINER} ..."
    "${DOCKER}" create \
        --name "${CONTAINER}" \
        --hostname "${HOSTNAME}" \
        $(printf " --publish %s" ${PORTS}) \
        $(printf " --volume %s" ${VOLUMES}) \
        --env GITLAB_OMNIBUS_CONFIG="${GITLAB_OMNIBUS_CONFIG}" \
        "${IMAGE}"
}

_update() {
    echo "Pulling docker image ${IMAGE} ..."
    "${DOCKER}" pull "${IMAGE}"
    _create
}

_remove() {
    _stop
    echo "Removing docker container ${CONTAINER} ..."
    "${DOCKER}" rm "${CONTAINER}"
}

_start() {
    _exists || _create
    echo "Starting docker container ${CONTAINER} ..."
    "${DOCKER}" start "${CONTAINER}"
    systemctl is-active gitlab-runner 1>/dev/null 2>&1 || ( sleep 60 ; sudo systemctl start gitlab-runner )
}

_restart() {
    _stop
    _start
}

_stop() {
    _gc
    systemctl is-active gitlab-runner 1>/dev/null 2>&1 && sudo systemctl stop gitlab-runner
    echo "Stoping docker container ${CONTAINER} ..."
    "${DOCKER}" stop "${CONTAINER}"
}

_exec() {
    "${DOCKER}" exec -it "${CONTAINER}" "${@}"
}

CMD="_${1:-start}"
shift

"${CMD}" "${@}"
