#!/usr/bin/env ruby

require 'rubygems'

def currents
  versions = %x[asdf current 2>&1].lines.map { |line| line.split[0..1] }
  versions = Hash[versions].select { |plugin, version| valid_version? version }
end

def latest(plugin)
  %x[asdf latest "#{plugin}"].strip
end

def valid_version?(text)
  text !~ /\Asystem|latest|__+\Z/
end

def version(text)
  Gem::Version.new(text)
rescue
  text
end

def outdated
  outdated = []

  currents.each do |plugin, current_version|
    latest_version = latest(plugin)
  
    if (version(latest_version) <=> version(current_version)) == 1 
       outdated << { plugin: plugin, current: current_version, latest: latest_version }
    end
  end

  outdated
end

def main
  outdated_plugins = outdated

  unless outdated_plugins.empty?
    format = "%<plugin>-8s  %<current>-20s  %<latest>-20s" 

    puts format % { plugin: "Plugin", current: "current", latest: "latest" }
    puts format % { plugin: "------", current: "-------", latest: "------" }

    outdated_plugins.each do |outdated|
      puts format % outdated
    end
  end
end

main
